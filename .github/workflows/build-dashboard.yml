name: Build Dashboard Standalone

on:
  workflow_dispatch:
  push:
    paths:
      - 'apps/dashboard/**'
      - 'packages/shared/**'
      - 'pnpm-lock.yaml'
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Build dashboard standalone
        run: STANDALONE=1 pnpm build:dashboard

      - name: Prepare tarball
        run: |
          # Copy static assets into standalone (Next.js standalone doesn't include them)
          cp -r apps/dashboard/.next/static apps/dashboard/.next/standalone/apps/dashboard/.next/static
          # Copy public folder if it exists
          if [ -d "apps/dashboard/public" ]; then
            cp -r apps/dashboard/public apps/dashboard/.next/standalone/apps/dashboard/public
          fi
          # Copy scripts directory (ws-terminal-server, bootstrap-pack — needed by systemd service)
          if [ -d "apps/dashboard/scripts" ]; then
            mkdir -p apps/dashboard/.next/standalone/scripts
            cp -r apps/dashboard/scripts/* apps/dashboard/.next/standalone/scripts/
          fi
          # Create tarball from standalone output
          cd apps/dashboard/.next/standalone
          tar -czf /tmp/dashboard-standalone.tar.gz .

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="dashboard-latest"
          # Delete existing release if present
          gh release delete "$TAG" --yes 2>/dev/null || true
          # Delete existing tag
          git push origin ":refs/tags/$TAG" 2>/dev/null || true
          # Create new release with the tarball
          gh release create "$TAG" \
            /tmp/dashboard-standalone.tar.gz \
            --title "Dashboard Standalone (${GITHUB_SHA::7})" \
            --notes "Auto-built dashboard standalone artifact from commit ${GITHUB_SHA::7}. Used by cloud-init for droplet deployments." \
            --prerelease

      - name: Auto-deploy to all active VPS dashboards
        env:
          DEPLOY_SECRET: ${{ secrets.DEPLOY_SECRET }}
        run: |
          echo "Triggering auto-deploy to all active dashboards..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://capable.ai/api/deployments/upgrade-all" \
            -H "Authorization: Bearer $DEPLOY_SECRET" \
            -H "Content-Type: application/json" \
            -d '{"tarballUrl": "https://github.com/iGOTHAM/capable-ai-2.0/releases/download/dashboard-latest/dashboard-standalone.tar.gz"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Auto-deploy triggered successfully"
          else
            echo "::warning::Auto-deploy returned HTTP $HTTP_CODE — deployments may need manual upgrade"
          fi
