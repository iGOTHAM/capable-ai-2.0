name: Build Dashboard Standalone

on:
  workflow_dispatch:
  push:
    paths:
      - 'apps/dashboard/**'
      - 'packages/shared/**'
      - 'pnpm-lock.yaml'
      - '.github/workflows/build-dashboard.yml'
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Nuke caches to ensure fresh build
        run: rm -rf .turbo apps/dashboard/.next node_modules/.cache

      - name: Build dashboard standalone
        run: STANDALONE=1 pnpm turbo build --filter=@capable-ai/dashboard --force
        env:
          TURBO_CACHE: ""

      - name: Write build stamp
        run: |
          echo "sha=${GITHUB_SHA}" > apps/dashboard/.next/standalone/apps/dashboard/public/build.txt 2>/dev/null || true
          echo "sha=${GITHUB_SHA}" > apps/dashboard/public/build.txt 2>/dev/null || true
          echo "time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> apps/dashboard/.next/standalone/apps/dashboard/public/build.txt 2>/dev/null || true
          echo "time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> apps/dashboard/public/build.txt 2>/dev/null || true

      - name: Prepare tarball
        run: |
          # Copy static assets into standalone (Next.js standalone doesn't include them)
          cp -r apps/dashboard/.next/static apps/dashboard/.next/standalone/apps/dashboard/.next/static
          # Copy public folder if it exists
          if [ -d "apps/dashboard/public" ]; then
            cp -r apps/dashboard/public apps/dashboard/.next/standalone/apps/dashboard/public
          fi
          # Copy sidecar scripts (ws-terminal-server, bootstrap-pack)
          mkdir -p apps/dashboard/.next/standalone/scripts
          cp apps/dashboard/scripts/*.mjs apps/dashboard/.next/standalone/scripts/
          # Create tarball from standalone output
          cd apps/dashboard/.next/standalone
          tar -czf /tmp/dashboard-standalone.tar.gz .

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="dashboard-latest"
          # Delete existing release if present
          gh release delete "$TAG" --yes 2>/dev/null || true
          # Delete existing tag
          git push origin ":refs/tags/$TAG" 2>/dev/null || true
          # Create new release with the tarball
          gh release create "$TAG" \
            /tmp/dashboard-standalone.tar.gz \
            --title "Dashboard Standalone (${GITHUB_SHA::7})" \
            --notes "Auto-built dashboard standalone artifact from commit ${GITHUB_SHA::7}. Used by cloud-init for droplet deployments." \
            --prerelease
