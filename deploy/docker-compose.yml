# =========================================
# Capable.ai — Stack Deployment
# =========================================
# Dashboard runs bare-metal via systemd (not Docker).
# This compose file runs OpenClaw + Caddy only.
#
# Usage:
#   1. Copy .env.example to .env and fill in values
#   2. docker compose up -d
#   3. systemctl start capable-dashboard  (bare-metal)
# =========================================

services:
  # ─── OpenClaw (AI Agent Runtime) ───
  openclaw:
    build:
      context: ./openclaw
      args:
        OPENCLAW_VERSION: ${OPENCLAW_VERSION:-2026.2.6-3}
    container_name: capable-openclaw
    restart: unless-stopped
    ports:
      - "127.0.0.1:18789:18789"   # Exposed to host localhost (dashboard connects here)
    volumes:
      - /opt/capable/openclaw-home:/root/.openclaw       # Shared with dashboard (bare-metal)
      - /opt/capable/data/activity:/data/activity         # Shared with dashboard (bare-metal)
    environment:
      - PROJECT_ID=${PROJECT_ID}
      - PROJECT_TOKEN=${PROJECT_TOKEN}
      - PACK_VERSION=${PACK_VERSION:-1}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://capable.ai}
      - GATEWAY_TOKEN=${GATEWAY_TOKEN}
      - OPENCLAW_GATEWAY_PORT=18789

  # ─── Caddy (Reverse Proxy + TLS) ───
  # Only needed when using a subdomain (e.g., jarvis.capable.ai)
  # If accessing via IP:3100 directly, this service can be omitted.
  caddy:
    image: caddy:2-alpine
    container_name: capable-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"   # Reach bare-metal dashboard on host
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - ./caddy/certs:/etc/caddy/certs:ro
    environment:
      - CAPABLE_SUBDOMAIN=${SUBDOMAIN:-localhost}
    depends_on:
      - openclaw

volumes:
  caddy-data:
  caddy-config:
